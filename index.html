<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Generador de Cartas | Canguro Venezuela</title>

    <style>
        /* Estilos Generales */
        body {
            font-family: Arial, sans-serif;
            margin: 40px;
            background-color: #000;
            color: #fff;
        }
        h1, h2 { text-align: center; }
        h1 { color: #FFD700; margin: 0 0 6px; }
        h2 { margin-bottom: 20px; }

        /* Estilos de Formulario (Oculto) */
        form {
            max-width: 520px;
            margin: 0 auto 30px auto;
            background: #111;
            border: 1px solid #FFD700;
            padding: 16px;
            border-radius: 8px;
        }
        label { display: block; margin-top: 10px; }
        input[type="text"], input[type="date"], button {
            width: 100%;
            padding: 8px;
            margin-top: 6px;
            box-sizing: border-box;
        }
        input {
            background: #222;
            color: #FFD700;
            border: 1px solid #FFD700;
        }
        button {
            cursor: pointer;
            margin-top: 12px;
            background-color: #FFD700;
            color: #000;
            font-weight: bold;
            border: none;
        }

        /* Bot贸n de Cerrar Sesi贸n */
        #cerrar-sesion {
            position: fixed;
            top: 20px;
            right: 40px; /* Ajustado para mejor posicionamiento */
            left: auto;
            background: none;
            color: #FFD700;
            font-weight: bold;
            border: none;
            font-size: 16px;
            cursor: pointer;
            text-decoration: underline;
        }
        .logo-wrap {
            text-align: center;
            margin-bottom: 16px;
        }
        .logo-wrap img {
            height: 100px;
            margin-bottom: 8px;
        }

        /* Bot贸n Masivo */
        #generar-masivo {
            max-width: 320px;
            margin: 0 auto 16px auto;
            display: block;
        }

        /* Tabla */
        #contenedor-principal {
            max-width: 1000px;
            margin: 0 auto;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
        }
        th, td {
            border: 1px solid #FFD700;
            padding: 8px;
            text-align: left;
            font-size: 14px;
        }
        thead {
            background-color: #222;
            color: #FFD700;
        }
        tr:nth-child(even) { background-color: #141414; }
        tr:hover { background-color: #1a1a1a; }
        .pie {
            text-align: center;
            font-size: 14px;
            color: #FFD700;
            margin-top: 30px;
        }

        /* Buscador por C茅dula */
        #buscador-cedula {
            max-width: 520px;
            margin: 0 auto 20px auto;
            padding: 15px;
            border: 1px solid #FFD700;
            border-radius: 8px;
            background: #111;
        }
        #buscador-cedula label { margin-top: 0; }
        #buscador-cedula input { margin-bottom: 10px; }
        #resultado {
            max-width: 520px;
            margin: 15px auto 30px auto;
            padding: 15px;
            border: 1px solid #FFD700;
            border-radius: 8px;
            background: #111;
            text-align: center;
        }
        .resultado-empleado strong { color: #FFD700; }
        .btn-buscar {
            background-color: #FFD700;
            color: #000;
            font-weight: bold;
            border: none;
        }
        .btn-generar {
            padding: 4px 8px;
            margin: 0;
            width: auto;
        }
        .oculto {
            display: none;
        }
        @media (max-width: 640px) {
            body { margin: 20px; }
            th, td { font-size: 12px; }
            .logo-wrap img { height: 80px; }
        }
    </style>
</head>
<body>
    <script>
        // Protecci贸n de ruta: requiere sesi贸n activa
        if (localStorage.getItem('sesionCanguro') !== 'activa') {
            window.location.href = 'iniciar-sesion.html'; // ajusta si tu login se llama diferente
        }
    </script>

    <button id="cerrar-sesion" onclick="cerrarSesion()">Cerrar sesi贸n</button>

    <div class="logo-wrap">
        <img src="logo-canguro.png" alt="Logo Canguro" />
        <h1>Generador de Cartas de Trabajo Canguro Venezuela</h1>
    </div>

    <form id="form-carta-html" class="oculto">
        <label class="oculto">C茅dula: <input type="text" name="cedula" required /></label>
        <label class="oculto">Nombre: <input type="text" name="nombre" required /></label>
        <label class="oculto">Cargo: <input type="text" name="cargo" required /></label>
        <label class="oculto">Raz贸n Social: <input type="text" name="razon" /></label>
        <label class="oculto">Ingreso: <input type="date" name="ingreso" required /></label>
        <label class="oculto">Egreso: <input type="date" name="egreso" /></label>
        <label class="oculto">Sueldo: <input type="text" name="sueldo" required /></label>
        <button type="submit" class="oculto"> Ver Carta</button>
    </form>
    
    <form id="buscador-cedula">
        <label for="cedula">Buscar por C茅dula (Generaci贸n R谩pida):</label>
        <input type="text" id="cedula" name="cedula" placeholder="Ej: 12345678" required />
        <button type="submit" class="btn-buscar">Buscar y Generar Carta</button>
    </form>

    <div id="resultado"></div>
    
    <h2 style="color: #FFD700;">Empleados Activos Organizacional</h2>
    
    <div id="contenedor-principal">
        <button id="generar-masivo">Generar cartas masivas</button>
        
        <table id="tabla-empleados">
            <thead>
                <tr>
                    <th><input type="checkbox" id="selectAll" /></th>
                    <th>C茅dula</th>
                    <th>Nombre</th>
                    <th>Cargo</th>
                    <th>Ingreso</th>
                    <th>Egreso</th>
                    <th>Sueldo</th>
                    <th>Raz贸n</th>
                    <th>Generar</th>
                </tr>
            </thead>
            <tbody id="cuerpo-tabla"></tbody>
        </table>
    </div>

    <p class="pie">Direcci贸n de Tecnolog铆a 2025 - Canguro Venezuela</p>


    <script>
        // Config Sheets
        const SHEET_ID = '19i5pwrIx8RX0P2OkE1qY2o5igKvvv2hxUuvb9jM_8LE'; // reemplaza por tu ID
        const API_KEY  = 'AIzaSyD8Su9VTM_oynBtrPvVA4zRyeu-UjeEJDw';       // reemplaza por tu API Key
        const RANGE    = 'Empleados!A2:N';

        let empleados = [];

        // Carga empleados desde Google Sheets
        async function cargarEmpleados() {
            const url = `https://sheets.googleapis.com/v4/spreadsheets/${SHEET_ID}/values/${RANGE}?key=${API_KEY}`;
            try {
                const res = await fetch(url);
                const data = await res.json();

                empleados = (data.values || []).map(row => {
                    const ingreso = row[3] || '';
                    const egreso  = row[4] || '';
                    
                    // Asumiendo que las columnas son 0:Cedula, 1:Nombre, 2:Cargo, 3:Ingreso, 4:Egreso, 5:Sueldo, 6:Razon, 12:Rif, 13:Direccion
                    return {
                        cedula: row[0] || '',
                        nombre: row[1] || '',
                        cargo:  row[2] || '',
                        ingreso,
                        egreso,
                        sueldo: row[5] || '',
                        razon:  row[6] || '',
                        rif:    row[12] || '',
                        direccion: row[13] || '',
                        estatus: egreso.trim() ? 'Egreso' : 'Activo'
                    };
                });

                const cuerpo = document.getElementById('cuerpo-tabla');
                cuerpo.innerHTML = '';

                empleados.forEach((emp, i) => {
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td><input type="checkbox" class="check-empleado" data-index="${i}" /></td>
                        <td>${emp.cedula}</td>
                        <td>${emp.nombre}</td>
                        <td>${emp.cargo}</td>
                        <td>${emp.ingreso}</td>
                        <td>${emp.egreso}</td>
                        <td>${emp.sueldo}</td>
                        <td>${emp.razon}</td>
                        <td><button class="btn-generar" data-index="${i}">Generar</button></td>
                    `;
                    cuerpo.appendChild(tr);
                });
            } catch (err) {
                console.error("Error al cargar datos de Google Sheets:", err);
                alert('Error al cargar empleados. Revisa tu SHEET_ID y API_KEY.');
            }
        }

        // Plantilla de carta y apertura para PDF (Print)
        function abrirCarta({ cedula, nombre, cargo, ingreso, egreso, sueldo, razon, rif, direccion }) {
            const fecha = new Date();
            const dia = fecha.getDate();
            const mes = fecha.toLocaleString('es-VE', { month: 'long' });
            const a帽o = fecha.getFullYear();

            const esActivo = !egreso || egreso.trim() === '';

            const cuerpo = esActivo
                ? `Por medio de la presente se hace constar que el ciudadano (a) ${nombre}, venezolano (a), mayor de edad y portador de la c茅dula de identidad N掳 ${cedula}, labora en esta empresa desde el d铆a ${ingreso}, en el cargo de ${cargo}, devengando un salario mensual de ${sueldo}.`
                : `Por medio de la presente se hace constar que el ciudadano (a) ${nombre}, venezolano (a), mayor de edad y portador de la c茅dula de identidad N掳 ${cedula}, labor贸 en esta empresa desde el d铆a ${ingreso} hasta la fecha ${egreso}, en el cargo de ${cargo}, devengando un salario mensual de ${sueldo}.`;

            const html = `
                <!DOCTYPE html>
                <html lang="es">
                <head>
                    <meta charset="UTF-8" />
                    <title>Constancia de Trabajo</title>
                    <style>
                        body { font-family: Arial, sans-serif; margin: 40px; line-height: 1.6; color:#000; }
                        h2 { text-align: center; font-size:16px; margin-bottom:10px; }
                        p  { margin: 8px 0; }
                        .firma { margin-top: 80px; text-align: center; }
                        /* Aseg煤rate de que los archivos 'logo-canguro.png' y 'foto-magda.png' est茅n en la misma carpeta */
                    </style>
                </head>
                <body>

                    <div style="
                        position: fixed;
                        top: 50%;
                        left: 50%;
                        transform: translate(-50%, -50%);
                        opacity: 0.08;
                        z-index: 0;
                    ">
                        <img src='logo-canguro.png' alt='Logo Canguro' style="height:190px;" />
                    </div>

                    <div style="width:600px; margin:0 auto; text-align:center;">
                        <div style="text-align:left; font-size:15px; margin-bottom:160px;">
                            <strong>${razon}</strong><br />
                            <strong>RIF:</strong> ${rif}
                        </div>
                        <h2>A QUIEN PUEDA INTERESAR</h2>
                        <p style="text-align:justify;">${cuerpo}</p>
                        <p style="text-align:justify;">
                            Constancia que se expide por la parte interesada en Caracas a los ${dia} d铆as del mes de ${mes} del a帽o ${a帽o}.
                        </p>
                        <div class="firma">
                            <p>__________________________</p>
                            <p><img src="foto-magda.png" alt="Firma Autorizada" style="height:80px;" /></p>
                            <p>MAGDA UZCTEGUI</p>
                            <p>GERENTE DE RECLUTAMIENTO Y SELECCIN</p>
                        </div>
                        <p style="text-align:center; font-size:14px; margin-top:160px;">
                            Direcci贸n: ${direccion}
                        </p>
                    </div>
                </body>
                </html>
            `;

            const win = window.open('', '_blank');
            win.document.write(html);
            win.document.close();
            win.focus();
            win.print();
        }

        // Buscador por c茅dula (AHORA USA LOS DATOS LOCALES PARA GENERAR LA CARTA)
        document.getElementById("buscador-cedula").addEventListener("submit", function(e) {
            e.preventDefault();
            const cedulaBusqueda = document.getElementById("cedula").value.trim();
            const resultadoDiv = document.getElementById("resultado");
            
            // Busca el empleado en el array cargado
            const empleadoEncontrado = empleados.find(emp => emp.cedula === cedulaBusqueda);

            if (empleadoEncontrado) {
                // Muestra el resultado
                resultadoDiv.innerHTML = `
                    <div class="resultado-empleado">
                        <p><strong>Nombre:</strong> ${empleadoEncontrado.nombre}</p>
                        <p><strong>C茅dula:</strong> ${empleadoEncontrado.cedula}</p>
                        <p><strong>Estatus:</strong> ${empleadoEncontrado.estatus}</p>
                    </div>
                `;
                // Genera la carta autom谩ticamente
                abrirCarta(empleadoEncontrado);
            } else {
                resultadoDiv.innerHTML = "<p>No se encontr贸 registro para la c茅dula ingresada en la base de datos local.</p>";
            }
        });

        // Generaci贸n masiva solo de seleccionados
        document.getElementById('generar-masivo').addEventListener('click', () => {
            const seleccionados = Array.from(document.querySelectorAll('.check-empleado:checked'))
                .map(chk => empleados[chk.dataset.index]);

            if (seleccionados.length === 0) {
                alert('Selecciona al menos un empleado');
                return;
            }

            seleccionados.forEach(emp => abrirCarta(emp));
        });

        // Seleccionar / deseleccionar todos
        document.getElementById('selectAll').addEventListener('change', e => {
            document.querySelectorAll('.check-empleado').forEach(chk => {
                chk.checked = e.target.checked;
            });
        });

        // Listener para botones individuales
        document.addEventListener('click', e => {
            if (e.target.classList.contains('btn-generar')) {
                const index = e.target.dataset.index;
                abrirCarta(empleados[index]);
            }
        }); 

        // Cerrar sesi贸n
        function cerrarSesion() {
            localStorage.removeItem('sesionCanguro');
            window.location.href = 'iniciar-sesion.html'; // ajusta al nombre real de tu login
        }
        
        // Inicializaci贸n
        cargarEmpleados();
    </script>
</body>
</html>